<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8"><title>Russian Dama Pro</title>
    <script src="/socket.io/socket.io.js"></script>
    <style>
        :root { --bg: #1a1a1a; --dark: #769656; --light: #eeeed2; }
        body { background: var(--bg); display: flex; flex-direction: column; align-items: center; font-family: sans-serif; color: white; margin: 0; }
        #lobby { position: fixed; inset: 0; background: rgba(0,0,0,0.9); z-index: 100; display: flex; flex-direction: column; justify-content: center; align-items: center; }
        #board { display: grid; grid-template-columns: repeat(8, 60px); grid-template-rows: repeat(8, 60px); border: 8px solid #3e3e3e; margin-top: 20px; }
        .cell { width: 60px; height: 60px; display: flex; justify-content: center; align-items: center; cursor: pointer; }
        .dark { background-color: var(--dark); } .light { background-color: var(--light); }
        .piece { width: 48px; height: 48px; border-radius: 50%; border: 3px solid rgba(0,0,0,0.3); z-index: 10; display: flex; justify-content: center; align-items: center; }
        .white { background: #f0f0f0; box-shadow: 0 4px #999; } .black { background: #333; box-shadow: 0 4px #000; }
        .king::before { content: 'â˜…'; color: gold; font-size: 24px; }
        .selected { outline: 4px solid gold; transform: scale(1.1); z-index: 20; }
        #status { font-size: 24px; margin: 20px; font-weight: bold; }
    </style>
</head>
<body>
    <div id="lobby">
        <h1>Russian Dama</h1>
        <input type="text" id="roomInput" placeholder="Room Name" style="padding:10px; margin-bottom:10px;">
        <button onclick="join()" style="padding:10px 20px; cursor:pointer;">Join Game</button>
    </div>
    <div id="status">Waiting...</div>
    <div id="board"></div>

    <script>
        const socket = io();
        let board = [], turn = 1, myColor = 0, roomId = "", selected = null, mustContinue = null;

        function join() {
            roomId = document.getElementById('roomInput').value;
            if (roomId) socket.emit('joinGame', roomId);
        }

        socket.on('init', d => { myColor = d.color; document.getElementById('lobby').style.display='none'; initBoard(); });
        socket.on('startGame', d => { turn = d.turn; updateUI(); });

        socket.on('syncMove', d => {
            applyMove(d.moveData);
            turn = d.nextTurn;
            selected = null; mustContinue = null;
            updateUI();
        });

        function initBoard() {
            for (let r=0; r<8; r++) {
                board[r] = [];
                for (let c=0; c<8; c++) {
                    let type = (r+c)%2!==0 ? (r<3?2 : (r>4?1:0)) : 0;
                    board[r][c] = { type, king: false };
                }
            }
            render();
        }

        function render() {
            const bEl = document.getElementById('board'); bEl.innerHTML = '';
            bEl.style.transform = myColor === 2 ? "rotate(180deg)" : "rotate(0deg)";
            for (let r=0; r<8; r++) {
                for (let c=0; c<8; c++) {
                    const cell = document.createElement('div');
                    cell.className = `cell ${(r+c)%2===0?'light':'dark'}`;
                    const p = board[r][c];
                    if (p.type !== 0) {
                        const d = document.createElement('div');
                        d.className = `piece ${p.type===1?'white':'black'} ${p.king?'king':''} ${selected?.r==r&&selected?.c==c?'selected':''}`;
                        if (myColor === 2) d.style.transform = "rotate(180deg)";
                        cell.appendChild(d);
                    }
                    cell.onclick = () => handleClick(r, c);
                    bEl.appendChild(cell);
                }
            }
        }

        function handleClick(r, c) {
            if (turn !== myColor) return;
            const p = board[r][c];
            if (mustContinue) {
                if (r===mustContinue.r && c===mustContinue.c) selected = {r,c};
                else if (selected) tryMove(r,c);
            } else if (p.type === myColor) {
                selected = {r,c};
            } else if (selected && p.type === 0) {
                tryMove(r,c);
            }
            render();
        }

        function tryMove(r, c) {
            const jumps = getJumps(selected.r, selected.c);
            const jump = jumps.find(j => j.r===r && j.c===c);
            const globals = getGlobalJumps(myColor);

            if (jump) {
                applyMove({r1:selected.r, c1:selected.c, r2:r, c2:c, jump});
                const nextJumps = getJumps(r, c);
                if (nextJumps.length > 0) {
                    mustContinue = {r, c}; selected = {r, c};
                } else {
                    socket.emit('makeMove', { roomId, moveData: {r1:selected.r, c1:selected.c, r2:r, c2:c, jump, nextTurn: myColor===1?2:1}});
                }
            } else if (globals.length === 0 && isValidNormal(selected.r, selected.c, r, c)) {
                socket.emit('makeMove', { roomId, moveData: {r1:selected.r, c1:selected.c, r2:r, c2:c, jump:null, nextTurn: myColor===1?2:1}});
            }
        }

        function applyMove(m) {
            const p = board[m.r1][m.c1];
            board[m.r2][m.c2] = {...p}; board[m.r1][m.c1] = {type:0, king:false};
            if (m.jump) board[m.jump.cap.r][m.jump.cap.c] = {type:0, king:false};
            if (!board[m.r2][m.c2].king && (board[m.r2][m.c2].type===1?m.r2===0:m.r2===7)) board[m.r2][m.c2].king = true;
        }

        function isValidNormal(r1, c1, r2, c2) {
            const p = board[r1][c1], dr = r2-r1, dc = Math.abs(c2-c1);
            if (p.king) {
                if (Math.abs(dr)!==dc) return false;
                for (let i=1; i<Math.abs(dr); i++) if (board[r1+i*Math.sign(dr)][c1+i*Math.sign(c2-c1)].type!==0) return false;
                return true;
            }
            return dc===1 && (p.type===1?dr===-1:dr===1);
        }

        function getJumps(r, c) {
            const p = board[r][c]; if (!p || p.type===0) return [];
            let res = [], dirs = [, [1,-1], [-1,1], [-1,-1]];
            if (p.king) {
                dirs.forEach(([dr, dc]) => {
                    let enemy = null;
                    for (let i=1; i<8; i++) {
                        let nr=r+dr*i, nc=c+dc*i;
                        if (nr<0||nr>7||nc<0||nc>7) break;
                        if (!enemy) {
                            if (board[nr][nc].type===p.type) break;
                            if (board[nr][nc].type!==0) enemy={r:nr, c:nc};
                        } else {
                            if (board[nr][nc].type!==0) break;
                            res.push({r:nr, c:nc, cap:enemy});
                        }
                    }
                });
            } else {
                dirs.forEach(([dr, dc]) => {
                    let mr=r+dr, mc=c+dc, er=r+dr*2, ec=c+dc*2;
                    if (er>=0&&er<8&&ec>=0&&ec<8 && board[er][ec].type===0 && board[mr][mc].type!==0 && board[mr][mc].type!==p.type)
                        res.push({r:er, c:ec, cap:{r:mr, c:mc}});
                });
            }
            return res;
        }

        function getGlobalJumps(player) {
            let res = [];
            for (let r=0; r<8; r++) for (let c=0; c<8; c++) 
                if (board[r][c].type===player && getJumps(r,c).length>0) res.push(true);
            return res;
        }

        function updateUI() {
            const s = document.getElementById('status');
            s.innerText = turn === myColor ? "YOUR TURN" : "OPPONENT'S TURN";
            s.style.color = turn === myColor ? "#2ecc71" : "#e74c3c";
            render();
        }
    </script>
</body>
</html>
